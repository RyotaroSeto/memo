## プロセス構成

- RDBMS はクエリの処理だけでなく、バッファの管理、ストレージへの書き込み制御、統計情報の収集などの制御を行っている。Postgres は複数のプロセスを動作させることで、複雑な制御を可能としている

## Postgres でそれぞれ動いているプロセス

- マスタサーバプロセス
  - PostgreSQL を制御する後述の様々なプロセス(バックグラウンドプロセス)や、外部からの制御を受け付け、接続に対応するプロセス(バックエンドプロセス)を起動する親プロセス
- ライタプロセス
  - 共有バッファ内の更新されたページを対応するデータファイルに書き出すプロセス
- WAL ライタプロセス
  - WAL をディスクに書き出すプロセス。WAL ライタプロセスでは、WAL バッファに書き込まれた WAL を設定に従って WAL ファイルに書き出す
- ロガープロセス
  - サーバーログを書き出す
- チェックポインタプロセス
  - チェックポイント(すべてのダーティページをデータファイルに反映し、特殊なチェックポイントレコードがログファイルに書き込まれた状態)を設定に従い、自動的に実行する
- 自動バキュームランチャプロセス
  - 自動バキュームを制御/実行するプロセス。ランチャは設定に従ってワーカを起動する。ワーカはテーブルに対して自動的にバキュームとアナライズを実行する、実行する前に対象のテーブルに大量の更新(挿入、更新、削除)があったかどうか統計情報を参照して検査する
- 統計情報コレクタプロセス
  - データベースの活動状況に関する稼働統計情報を一定間隔で収集するプロセス。収集された稼働統計情報は PostgresSQL の監視などで用いられる
- バックグラウンドワーカプロセス
  - ロジカルレプリケーション用のワーカ
- バックエンドプロセス
  - クライアントから接続要求を受けた時に生成されるプロセス。
  - クエリの実行はこのプロセス内で行われる。
- パラレルワーカプロセス
  - パラレルクエリが実行される際に、バックエンドプロセスから起動されるプロセス

## メモリ管理

- PostgresSQL で使われるメモリは PostgresSQL サーバプロセス全体で共有される共有メモリ域とバックエンドプロセスで確保されるメモリプロセス域の 2 つに区別される
- **共有メモリ域**
  - バックグラウンドプロセスとバックエンドプロセスの全てから参照や更新される共有領域
  - この領域はサーバの起動時に OS のシステムコールにより予約される。また以下に分かれる
  - 共有バッファ(shared_buffers)
    - テーブルやインデックスのデータをキャッシュする領域
  - WAL バッファ(wal_buffers)
    - ディスクに書き込まれていないトランザクションログをキャッシュする領域
  - 空き領域マップ(Free Space Map)
    - テーブル上の利用可能な領域を指し示す情報を扱う領域
    - PostgresSQL ではメンテナンス処理(バキューム処理)時にトランザクションから全く参照されていない行を探して、空き領域として再利用を可能にする。追加や更新時に空き領域マップを探索し、再利用可能な領域に新しい行を挿入する
  - 可視性マップ(Visibility Map)
    - テーブルのデータが可視であるか否かを管理する情報を扱う領域
    - バキューム処理の高速化のために、処理に必要なページかどうかを可視性マップで判断する。また、インデックスオンリースキャンという高速な検索方式でも使用されている。
    - 可視性マップの情報はバキューム処理や各更新処理のタイミングで書き換えられる。また、この空き領域マップを参照して、バキューム処理の高速化にも使われる
- **プロセスメモリ域**
  - バックエンドプロセスごとに確保される作業用のメモリ領域。メモリ領域を確保したプロセスのみが参照可能であり、以下のように分類される
  - 作業メモリ(work_mem)
    - クエリ実行時に行われる、並び替えとハッシュテーブル操作のために使われる領域。
    - 並び替えやハッシュテーブル操作を含むクエリの場合、作業メモリを適切に設定することで性能の向上が期待できる。1 つのクエリの中でこれらの操作が複数回行われる場合は該当する処理ごとに設定した領域が確保される。
  - メンテナンス用作業メモリ(maintenance_work_mem)
    - バキューム、インデックス作成、外部キー追加などデータベースメンテナンスの操作で使用する領域。
    - メンテナンス時間の短縮を目指すのであれば work_mem より大きめに設定することが望ましい
  - 一時バッファ(temp_buffers)
    - バックエンドプロセスごとに作成される一時テーブルにアクセスする時に用いられるメモリ領域。一時テーブルは create temp table コマンドで作成できる

## ファイル

- postgreSQL で使われるファイルの多くはデータベースクラスタと呼ばれるディレクトリ配下に作成される。データベースクラスタは initdb コマンドまたは pg_ctl コマンドで実行した OS ユーザのみアクセス可能な権限で作成される。postgreSQL は起動時にデータベースクラスタのアクセス権限をチェックして、700 以外の場合エラーメッセージを出力する。データベースクラスタには様々なディレクトリやファイルが作成される。主なディレクトリは以下。
- base ディレクトリ
  - データベースごとに識別子を示す数字のディレクトリが作成される。
  - データベースディレクトリは base ディレクトリ配下に格納され、テーブルファイル、インデックスファイル、TOAST ファイル、Free Space Map ファイル、Visibility Map ファイル等が格納される
- global ディレクトリ
  - データベースクラスタで共有するテーブルを保有するディレクトリ。
  - pg_database など複数のデータベースにまたがるシステムカタログなどで格納されている
- pg_wal ディレクトリ
  - WAL ファイルを格納するディレクトリ。
  - データベースクラスタ作成時のオプションによって、シンボリックリンクとなる場合もある
- pg_xact ディレクトリ
  - トランザクションのコミット状態を管理するファイルが格納されるディレクトリ
- pg_tblspc ディレクトリ
  - PostgreSQL では、テーブルやインデックスなどのデータベースオブジェクトを base ディレクトリ以外の任意のディレクトリに格納できる。テーブル空間として作成されたディレクトリへのシンボリックリンクを pg_tblspc に格納する
- 以下は主なファイル
  - pg_version ファイル
    - postgresql のメジャーバージョン番号が書き込まれているテキストファイル。cat コマンドなどで参照できる
    - 起動する postgresql のメジャーバージョンと使用するデータベースクラスタのバージョンチェックのために用いられる。postgresql では異なるメジャーバージョン間ではデータベースクラスタの互換性がない。無理に起動するとデータベースクラスタ内に作成されるファイルやフォーマットがことなるため、想定外の動作を起こす可能性がある。このような誤動作を防止するために、起動した postgresql のバージョンと指定したデータベースクラスタ配したの version ファイルの値を比較してる
  - テーブルファイル
  - インデックスファイル
  - TOAST ファイル
    - テーブル内の長大な行を格納する場合に生成される特殊なファイル。
    - データベースディレクトリ配下に格納される
    - 長いデータの列は TOAST ファイルに分割格納される。
  - Free Space Map ファイル
    - 空き容量を追跡するためのファイル
    - データベースディレクトリ配下に格納される
  - Visibility Map ファイル
    - テーブルの可視性を管理するファイル
    - 「テーブルを示す数字\_vm」という名前でデータベースディレクトリ配下に格納される
  - WAL ファイル
    - postgresql に対して行われた更新操作を記録するファイル。
    - pg_wal ディレクトリ配下に格納される
    - データベースの永続性の保証やリカバリ時に非常に重要な役割を果たす
    - wal ファイルは固定長のファイルで、initdb 実行時にサイズを指定する。default は 16MB
    - WAL ファイル群は目安として max_wal_size に設定したサイズ程度が生成される
  - postgresql.conf,pg_hba_conf
    - postgresql の動作を設定するファイル
  - postmaster.pid
    - postgresql の稼働中に作成されるロックファイル
    - データベースディレクトリ配下に格納される
    - このファイルが存在しているとき、同じデータベースクラスタを指定して postgresql を起動すると二重起動エラーになる
