# 設定

- postgres は何も設定しないと最低限動作をするためにデフォルト設定で起動するが実際にシステムで使う時は、要件に合わせて設定する必要がある。
- 各種設定ファイル(`postgresql.conf`,`pg_hba.conf`,`pg_ident.conf`)の設定方法など

## `postgresql.conf`ファイル

- postgreSQL 全体の動作を制御する設定ファイル。

| カテゴリ名                   | 説明                                                 |
| ---------------------------- | ---------------------------------------------------- |
| 接続と認証                   | 接続、セキュリティ、認証の設定                       |
| 資源の消費                   | 共有メモリ、ディスク、ライタプロセスの設定           |
| ログ先行書き込み(WAL)        | WAL、チェックポイント、アーカイブの設定              |
| レプリケーション             | レプリケーションの設定                               |
| 問い合わせ計画               | 問い合わせに対する実行計画の設定                     |
| エラー報告とログ取得         | サーバーログ出力に関する設定                         |
| 実行時統計情報               | 統計情報の収集に関する設定                           |
| 自動バキューム作業           | 自動バキュームに関する設定                           |
| クライアント接続デフォルト   | 接続したクライアントの挙動やロケールに関する設定     |
| ロック管理                   | ロックやデッドロック検知の設定                       |
| バージョンとプラットフォーム | 旧バージョンやプラットフォーム間の互換性に関する設定 |
| エラー処理                   | エラーや障害発生時の設定                             |

- 設定ファイルの分割と統合

  - 設定ファイルは分割して管理することもできる。レプリケーション構成など複数のサーバーで一部の設定を共用したい場合などにサーバー固有の設定でファイルを分割し include で統合する使い方が可能。下記はメモリに関する設定のみ分離している

  ```sql
  ・postgresql.conf
  include 'memory.conf'

  ・memory.conf
  shared_buffers = 512MB
  work_mem = 64MB
  ```

- Alter system コマンドによる postgresql.conf の変更
  - postgresql.conf の直接編集の他に Alter system コマンドで変更もできる
  - set サブコマンドによる設定された、postgresql.auto.conf を reset サブコマンドによって取り消せる
  - Alter system の set サブコマンドによる設定の変更を行うと postgresql.auto.conf という名前の設定ファイルの内容が更新される。
  - Alter system コマンドによる設定変更は即時に反映されない。設定の再ロード(cg_ctl reload) やサーバーの再起動(pg_ctl restart)を実行することで、postgresql.auto.conf に設定された内容が反映される
  - 直接編集するより Alter system コマンドを使用するメリット
    - 設定の誤りを Alter system コマンドの実行時にチェックできる
    - スーパーユーザがリモートサーバからログインできる環境の場合、永続的な設定の変更をリモートサーバから実行できる
  - **直接編集するか Alter system コマンドを使用するかはルールを決めることが大切**

## `pg_hba.conf`ファイル

- クライアントから PostgreSQL への接続と認証に関する設定するファイル
- PostgreSQL はどこから誰がどのデータベースにアクセスするかで接続と認証を管理している
- `pg_hba.conf`ファイルは PostgreSQL 起動時とマスタサーバプロセスへ SIGHUP シグナルを送信したタイミングで読み込まれる。SIGHUP シグナルは pg_ctl コマンドに reload オプションを付与して送信できる
- pg_hba.conf ファイルの記述例
  - postgres は全てにアクセス可能。admin は db1,db にアクセス可能。

```sql
local   all   postgres               trust
host    all   postgres   localhost   trust
host    db1,db2 admin    192.168.100.10
host    db1   user1    192.168.100.10/24
```

- 接続方式
  - 接続方式は`local`,`host`,`hostssl`,`hostnossl`の 4 種類がある
  - local
    - unix ドメインソケットを使用する接続に対応。`postgresql.conf`の`listen_addresses`に空文字を指定した場合に指定する
  - host
    - TCP/IP を使用した接続に対応。SSL 通信の有無は問わない。`ostgresql.conf`の`listen_addresses`で localhost のみ設定されている場合、別サーバーから接続できない。
  - hostssl
    - SSL を用いた通信方式にのみ対応する指定
  - hostnossl
    - SSL を用いない通信方式にのみ対応する指定
  - hostgssenc
    - TCP/IP を使用した接続かつ、GSSAPI 暗号化を使用した接続のみ対応する指定
  - hostnogssenc
    - TCP/IP を使用した接続かつ、GSSAPI 暗号化を使用しない接続のみ対応する指定
  - local 接続の場合は「接続データベース」「接続ユーザー」「認証方式」を指定し、host/hostssl/hostnossl/hostgssenc/hostnogssenc 接続の場合は、加えて「IP アドレスを指定する」
  - ssl 接続について
    - クライアントと PostgresSQL サーバ間の通信を暗号化する。利用には次の条件が必要
      - OpenSSL が PostgreSQL サーバーだけでなくクライアントの両方にインストールされている
      - PostgreSQL ビルド時に、SSL 接続を有効にするオプションを付与する
      - インストール後`postgresql.conf`ファイルで ssl パラメータの設定値を on にする
- 接続データベース
  - all
    - 全てのデータベースへの接続に対応
  - sameuser
    - 指定したユーザと同じ名前のデータベースへの接続に対応
  - samerole
    - データベースと同じ名前のロールのメンバでなければならない
  - replication
    - レプリケーション接続に対応
  - @記号が先頭にある場合
    - データベース名そのものではなく、データベース名を含むファイル名
    - ファイル名は pg_hba.conf の存在するディレクトリからの相対パスまたは絶対パスで記述する
  - ※ログイン属性
    - PostgreSQL ではロールという概念でユーザやユーザのグループを管理している。ロールは主にデータベースの所有権限や各種操作の実行権限を制御している
    - ロールは権限だけでなく、ロール自体の属性を持っている。属性の 1 つに「ログイン」というものがあり、create user コマンドで作成した場合、ログイン属性は default で有効になるが、create role コマンドで作成した場合は default で無効となる。
- 接続ユーザ
  - 接続時の DB ユーザ名を記述する。all は全ての DB ユーザからの接続に対応する
  - その他の場合、先頭に「+」があるかないかの 2 パターンある
    - 先頭に「+」がない場合
      - 記述に完全一致するデータベースユーザ名に対応
    - 先頭に「+」がある場合
      - 指定されたロールのメンバと一致する場合に対応
- 接続元 IP アドレス
  - サーバに接続するクライアントのアドレスを記述
  - アドレスの記述方法は、「ホスト名」「IP アドレス(IPv4,IPv6)」を指定できる
  - IPv4 での「0.0.0.0/0」,IPv6 での「::/0」はそれぞれ全ての IP アドレスを示す記法
  - 「all」は IPv4,IPv6 ともに全ての IP アドレスに一致するという意味
  - 「samehost」はサーバが持つ全ての IP アドレスに一致するという意味
  - 「samenet」はサーバが接続しているサブネット内の IP アドレスに一致するという意味
- 認証方式
  - クライアントから接続する時の認証方式
  - 単純な認証制限を設けたい場合、パスワード文字列の暗号学的ハッシュ形式を送信する「scram-sha-256」方式を選択するのが無難
  - 「trust」は検証環境や外部から隔離されたネットワーク内で使用する場合に使う
  - 特定のホストを除外するためには「reject」を使う
- pg_hba_file_rules ビュー
  - pg_hba.conf ファイルの内容を select で参照できる pg_hba_file_rules ビューがある。このビューは pg_hba.conf のファイル内に記述エラーがあった場合、そのエラー内容を error 列に表示する。pg_ctl reload で設定を反映する前に、この pg_hba_file_rules ビューを確認して、設定ミスを未然に防ぐことができる。このビューは特権ユーザのみ参照可能

## `pg_ident.conf`ファイル

- ident 認証や GSSAPI 認証など外部の認証システムを利用する場合に使用される、データベースクラスタ配下のユーザ名マップ設定ファイル。
- `pg_ident.conf`ファイルは以下の 3 つの列からなる行を 1 つの設定として記述する
  - map name
    - `pg_fba.conf`の auth-options で参照される任意の名称を設定
  - system user name
    - 接続を許すクライアントの OS ユーザ名を設定。正規表現を用いた指定が可能
  - database user name
    - system user name で設定したクライアントの OS ユーザが PostgreSQL サーバのどのユーザで接続するかを設定する
