# バックアップ計画

## リカバリ要件

- 障害発生時にどの時点までのデータを復元するか
- データベースの再開までに許容される時間がどの程度あるか

レプリケーション構成で使用するスタンバイは、厳密にはバックアップとしては扱えないということは注意する必要あり。バックアップとして扱えない理由の一つは、誤った操作を行なってしまった場合、スタンバイでは、プライマリの操作内容が反映されるため、スタンバイを使用しても誤った操作を行う前の状態にデータベースを戻すことができない

## PostgreSQLのバックアップ方式

### オフラインバックアップ

- 物理バックアップ
    - コールドバックアップと呼ばれる方式。PostgreSQLを停止してデータベースクラスタのバックアップを取得する。リストアはバックアップ取得時点まで
    - 長所: 手順が簡易
    - 短所: 運用中にバックアップできない。復元できる時点はバックアップ取得時点のみ

### オンラインバックアップ

- 論理バックアップ
    - pg_dumpやpg_dumpallを用いて、データベースの中身全体あるいは一部を論理的に抽出する方式。復元できるのはバックアップ取得時点まで。パラレルpg_dumpやパラレルpg_restoreを使用することで、CPUコア数やディスク性能に余裕のあるケースでは効率よくバックアップ/リストアを行える。物理バックアップとは異なり、データベースの一部のみをバックアップとして取得できる
    - 長所: 運用中にバックアップできる。手順が簡易。データベースから部分的にバックアップできる
    - 短所: 復元できる時点はバックアップ取得時点のみ。物理バックアップに比べて復元にかかる時間が長い
- 物理バックアップ
    - データベースのデータとリカバリに必要な物理ファイルをバックアップとして取得する方式。データベースのデータはベースバックアップと呼ばれ、バックアップ済みのWALファイル(アーカイブログ)と組み合わせることで、データベースバックアップ取得後(pg_basebackupコマンド、pg_stop_backup関数実行移行)の任意の時点に復元できる
    - 長所: 運用中にバックアップできる。任意の時点にリカバリできる
    - 短所: 運用手順が煩雑

## 各バックアップ方式の注意点

### コールドバックアップの注意点

- PostgreSQLを停止し、データベースクラスタをまるごとバックアップすれば完了。任意のテーブル空間を作成している場合、その領域も忘れずにバックアップを取得する
    - テーブル空間を作成している場合、データベースクラスタ配下のpg_tblspcには実際のテーブルやインデックスが格納される領域へのシンボリックリンクが格納されているだけなので、リンク先にあるデータ実体もきちんとバックアップする必要がある。バックアップ取得時に使用するコマンドによって、シンボリックリンクだけ取得してしまうこともあるので注意
    - リストア/リカバリについても注意が必要。データベースクラスタ、テーブル空間のデータをすべて元の位置に配置しなおしてPostgreSQLを起動する必要がある。
    - WAL領域(pg_wal)の位置にも気を付ける必要がある。DBクラスタ作成時にinitdb -xでデフォルトとは異なる位置にWAL領域を指定していた場合にはテーブル空間同様にデータベースクラスタ配下のpg_walは実際のWAL領域を指し示すシンボリックリンクとなるエル。このため実体であるWAL領域のWALファイルも確実にバックアップする必要がある

### オンライン論理バックアップの注意点

- PostgreSQL付属コマンドのpg_dumpもしくはpg_dumpallを用いてオンライン論理バックアップを取得する。
    - pg_dumpではプレーンテキスト、カスタム、tar、ディレクトリといった形でバックアップを取得可能。リストア時はプレーンテキスト形式であればpsqlを用い、バイナリ形式であればpg_resotreを用いる
    - pg_dumpではデータベース/テーブル単位のバックアップが可能だが、逆にユーザやデータベースクラスタ全体に共通のデータはバックアップできないことにも注意が必要。これらのデータをバックアップする際には、pg_dumpallを用いてバックアップを取得する。
    - pg_dump,pg_dumpallともテーブル空間やラージオブジェクトのバックアップに対応している。
    - その他注意すべき点は、PostgreSQLの設定ファイル類のバックアップが取得できないこと。postgresql.confやpg_hba.congなどの情報は論理バックアップでは取得できないので、必要な場合は論理バックアップとは別に各ファイルのコピーが必要

### オンライン物理バックアップの注意点

- コールドバックアップの注意点と同様にテーブル空間、WAL領域のデータも確実にバックアップする必要がある。pg_basebackupコマンドを利用する場合は、PostgreSQLがレプリケーションを行える状態になっている必要があるが、テーブル空間やWAL領域のバックアップを取得するためのオプションが提供されているため、積極的に利用すべき。
- pg_basebackupは１プロセスで物理バックアップを取得する仕様のため、バックアップにかかる時間はデータベースクラスタのサイズに比例する。大規模なデータを使う場合、pg_basebackupでバックアップ要件を満たせるか確認する
