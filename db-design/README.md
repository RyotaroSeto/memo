# DB

## 物理設計のステップ

1. テーブル定義
2. インデックス定義
3. ハードウェアのサイジング
   1. システムが十分な性能を発揮できるだけの CPU やメモリを持ったサーバー、ストレージを選定
   2. データベースの性能問題の 8 割はディスク I/O により起こる
4. ストレージの冗長構成決定
5. ファイルの物理配置決定

## ストレージの冗長構成

- RAID
  - 複数のディスクに同じデータを書き込んで冗長化すること。可用性を高めるもの。
  - 採用できるなら、RAID10 が望ましい。厳しいなら RAID5 を採用する
  - RAID0
    - データを異なるディスクに分散して保持する。ディスク 1 本でも故障したらデータが失われるため、冗長性は全くない。
  - RAID1
    - 2 本のディスクに全く同じデータを持つ。2 本で一つのデータを保持するため、ディスク使用効率も良くない。性能はそれほど求められないが、高い信頼が求められる場合検討する
  - RAID5
    - 最低 3 本で構成し、データとともに「パリティ」と呼ばれる誤り符号訂正符号を分散して格納する。ディスクが壊れたとしても、パリティから実データ復元可能。データを分散できるため I/O 性能(読み出し)の向上も期待できる。
  - RAID10
    - RAID0 と RAID1 のいいとこどり。(ストライピングとミラーリングのいいとこどり)欠点として、必要となるディスクの本数が多いため、コストが高い(最低でも 4 本必要)

## ファイルの物理配置

- データベースのファイルをどのディスクに配置するか考える
- 基本的に「データファイル」と残りを異なるディスク(RAID グループ)に配置する
- データベースに格納されるファイルは用途別に以下 5 種類に大別できる
  - データファイル
    - データベースに格納するデータを保持するためのファイル。アプリケーションから見えるのはあくまでも「テーブル」という倫理的単位
  - インデックスファイル
    - テーブルに作成されたインデックスが格納されるファイル
  - システムファイル
    - DBMS の内部管理用に使われるデータを格納する
  - 一時ファイル
    - DBMS の内部での一時的なデータを格納するために使われる
    - 一時的なデータとは例えば SQL で使われたサブクエリを展開したデータや、GROUP BY 句よ DISTINCT を利用したときのソートデータなど
  - ログファイル
    - DBMS はテーブルのデータに対する変更を受け付けた場合、一旦ログファイルに変更分を溜め込んだ後、一括してデータファイルに変更を反映する。Postgres では「トランザクションログ」、MySQL では「バイナリログ」。
    - データファイルに反映が終われば、不要になるため、継続的にサイズが増加するタイプのものではない。

## バックアップ設計

- 以下 3 種類がバックアップ方式
  - フルバックアップ
    - 欠点 1:バックアップの時間が長い
    - 欠点 2:ハードウェアリソースへの負荷が高い
    - 欠点 3:サービス停止が必要
      - システムで「ただいまシステムメンテナンス中です」という画面はフルバックアップしている可能性が高い
      - 半年や 1 年単位でしかフルバックアップを取らないというシステムも珍しくない
  - 差分バックアップ
    - 差分バックアップはログファイルをバックアップすることで実現する
      - DBMS はユーザーから受け付けた変更をすぐにデータファイルに反映するのでなく一旦トランザクションログに溜め込むため、トランザクションログにはデータベース内のデータに対するあらゆる変更操作履歴が残っている
      - 前回のバックアップからのデータを累積的に保持
    - 利点 1:バックアップデータ量が減ること
    - 欠点 1:リカバリの時、フルバックアップファイル(データファイル)だけでなく、差分ログも運用する必要があるため、リカバリの手順が増えて時間も長くなる。
  - 増分バックアップ
    - 差分バックアップと基本的な考えは同じ。
      - 前回のバックアップからの増分データのみを保持
    - 差分バックアップには無駄があり、最新のログファイルが古いログファイルの内容も包含するという関係にある。(リカバリの際には最新のログファイルだけで良いが他のファイルも必要としていた。)トランザクションログから一切の無駄を省いたバックアップ方式。常に必要なログしかバックアップしない。
    - 利点 1:バックアップデータ量が最も最小
    - 欠点 1:リカバリ手順が複雑

## リカバリ設計

- バックアップファイルだけではデータの状態を障害の直前に戻すことが不可能
- リストア
  - バックアップファイルをデータベースに戻す
- リカバリ
  - トランザクションログを適用して変更分を反映する
  - トランザクションログは DBMS 内部にも残っており、その中に最後のバックアップ後に実施されたユーザーからの変更分が残っている。この未バックアップのトランザクションログまで適用することで、初めてデータは障害直前の状態に復旧できる。
- したがって、リストアおよびリカバリ手順は以下
  1. フルバックアップのファイルをデータベースに戻す(リストア)
  2. 差分バックアップしていたトランザクションログを適用する(リカバリ)
  3. データベースサーバーに残っているトランザクションログを適用する(ロールフォワード)

## データベースサーバーのクラスタリング構成

- データベースサーバーの物理構成として、**スタンドアロン**という形式がある。1 台だけサーバーを用意する方式。サーバーに障害が起きたら即座にシステム停止、かつ性能もほぼスケーラビリティがない。
- そこで、信頼性と性能を向上させるため、DB サーバーを複数台で構成する**クラスタリング**が採用される。**クラスタリング**の種類は以下
  - Active-Standby 方式
    - 動いているのは現用系(Active)だけで、もう一方の待機系(Standby)は全く処理をしない。ただ、現用系に障害が発生した場合には待機系に切り替わり、少ない停止時間でシステムが復旧できる利点がある。
    - 基本的にサーバー 2 台で構成し、動いているのはそのうち 1 台だけなので、性能はスタンドアロンと変わらない。
  - Active-Active 方式
    - 待機系というサーバーは存在せず、すべてのサーバーが現用系。処理を各サーバーに分散することができ、かつ台数も特に限定せず増やすことができるので、信頼性のみならず性能的にも有利な方式。
    - Active-Active 方式にも 2 種類方式がある
      - シェアードディスク方式
        - ディスクだけをサーバー間で共有して、CPU、メモリ、ネットワークなどの資源は分離する構成。
        - 利点:どのサーバーからも共通のデータを参照/更新することができるため、どのサーバーに障害が発生しても残りのサーバーで処理を継続することができる。
        - 欠点:共有資源となるディスクがボトルネックポイントになりやすく、そこが原因でサーバー台数を増やしても性能向上が頭打ちになる
      - シェアードナッシング方式
        - ディスクを含むあらゆるリソースをサーバー間で共有しない方式。
        - 利点:構造的にボトルネックを発生しないため、サーバー台数を並べることで性能が上がっていく
        - 欠点:データーの含まれるディスクを共有しないため、各サーバーのアクセスできるデータ限られる。そのため特定のサーバーがダウンすると、残りのサーバーが稼働していても、一部のデータにアクセスできない状態が発生する
