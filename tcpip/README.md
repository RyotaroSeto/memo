# TCP/IP

## ネットワークの歴史

- 1960年代は1台の大型コンピューターの処理を細かい時間に分割して、みんなで使用する「TSS」という方式でコンピューターを使用していた。遠隔地にいるユーザーはTSS端末から大型コンピューターに対して電話をかけてアクセスし、それが自分専用のコンピューターであるかのように扱うことができた。TSSにより、大型コンピューターとTSS端末の2台だけで構成されるシンプルなネットワークができた
- 1970年代になると、大型コンピューターだけでなく、マイコンのような小型コンピューターも登場し、たくさんのコンピューターを並列につないでいくようになった。その中でも重要な「ARPANET」がある。ARPANETはデータを「パケット」と呼ばれる小さな単位に分割してやりとりする「パケット交換方式」という伝送方式を世界で初めて採用した
- データの伝送方式には「回線交換方式」と「パケット交換方式」の2種類がある
- 回線交換方式
    - データをやり取りする前に1対1の伝送路(データの通り道)を作り、やり取りが終わるまで使い続ける方式。接続している間、回線を占領し繋ぎっぱなしのため効率が良くなかった
- パケット交換方式
    - 回線交換方式で課題となった回線利用率向上を目的として作られた
    - データを「パケット」と呼ばれる小さな単位で分割して、ネットワークに流す方式。送信側のコンピューターはデータに「ヘッダー」という情報をくっつけて、パケット交換機(ネットワーク機器)で構成されたパケット交換ネットワークにパケットを流す。ヘッダーには宛先となるコンピューター情報だったり、データの何番目に当たるパケットなのかだったり、色々な情報が含まれる
    - パケット交換ネットワークは、ヘッダーの情報を見て、宛先のコンピューターにパケットを送り届ける。また宛先コンピューターはヘッダーの情報を見て元のデータに復元する。
    - パケット交換方式は必要な時に必要な分だけ回線を利用できるだけでなく、その回線を利用して別のユーザーのデータも流すことができるため効率よく回線を使用できる
    - 経路上のどこかでパケットがなくなったり、パケットが壊れたりしても、すべてのデータを再送する必要はなく、その小さなパケットだけを再送すればよいのですぐに復旧できる
    - ネットワークをはじめとする現在のコンピューターネットワークはパケット交換方式でデータをやりとりしている。私たちのPCが元のデータに戻して、初めてyoutubeなど見ることができる

## 通信する時のルールがプロトコル

- パケットを処理する時のルールがプロトコル
- プロトコルが通信に必要な機能ごとしっかり整備されているおかげでPCのメーカーやOS、無線優先など気にすることなく、同じパケットでやり取りできる
- 「https」がまさにプロトコルにあたる
    - webブラウザ間の間で暗号化しながらパケットをやり取りする時に使用するプロトコル
    - httpsをつけることによって、httpsで決められた約束事に基づいてパケットを処理しますよと宣言している
- プロトコルで決まっていること
    - 物理的な使用
        - 有線の場合、テーブルの素材やコネクタの形状、そのピン配列に至るまで、ネットワークにおいて、目に見えるものはすべてプロトコルで定義される。
        - 無線の場合、Wi-Fi環境における電波の周波数やパケットをどのように電波に変換するかもプロトコルで定義されている
        - PCのNIC(Network Interface Cardはプロトコルで定義されている内容に基づいて、ケーブルや電波などの伝送媒体にパケットを流す
    - 送信相手の特定
        - ネットワークの世界でも、現実の世界と同じように住所を割り当てて、送信相手を区別している
            - ドメイン
            - IPアドレス
    - パケットの転送
        - データをパケットに分割して流している。
        - プロトコルでは、ヘッダーのどこからどこまで(何ビット目から何ビット目までに)どんな情報を含み、どんな順序でやりとりするかが定義されている
        - パケット交換ネットワークを構成しているパケット交換機はヘッダーの情報に基づいてバケツリレー的にパケットを転送している
    - 信頼性の確立
        - プロトコルはエラーを通知したり、データを再送したりしている
        - 有限なネットワークリソースがパケットでいっぱいにならないための仕組みも提供している
        - MVNOのスマホを使用している時、Webサイトが見づらくなる理由は、限られたネットワーク帯域をみんなで共有しており、ネットワーク制限されているため
        - MVNO
            - 携帯電話会社(NTTなど)から基地局などの通信設備を借りて、携帯電話サービスを提供している事業者、格安スマホや格安SIMなどの会社のこと
    - セキュリティの確保
        - プロトコルは重要な情報を安心してやり取りできるように正しい通信相手であるか認証し、通信を暗号化する仕組みを提供している。
        - 例えば、ユーザー名とパスワードでログインする時、Webブラウザは接続先のサーバーが正しい通信相手であることを確認した上で、ユーザー名とパスワードを暗号化して送信する
            - 正しい相手と通信しているか確認
            - 盗聴されてもわからないように暗号化
- プロトコルは階層で整理する
    - データの送信元のコンピューターは階層ごとに用意されたプロトコルに沿って、上の階層から順にデータを処理していき、パケットとして伝送媒体に流す
    - パケットを受け取ったコンピューターは逆に、下の階層から順に階層ごとに送信元コンピューターと同じプロトコルに沿ってデータを処理し元のデータに戻す。
- 二つの階層構造モデル
    - TCP/IP参照モデル
        - 以下、下から順に4層で構成されている。それぞれ順々に処理を行う。
        - リンク層
            - 第1層。デジタルデータを物理的な伝送媒体に流す変換や変調処理を行い且つその信頼性を確保する処理を行う(同じネットワークにいる端末と接続性を確保)
            - IEEE8023など
        - インターネット層
            - 第2層。宛先となるコンピューターまでの通信経路を確保する処理を行う(異なるネットワークにいる端末と接続性を確保)
            - IP,ICMP
        - トランスポート層
            - 第3層。アプリケーションの識別を行い、それに応じた通信制御を行う
            - TCP,UDP
        - アプリケーション層
            - 第4層。ユーザーに対してアプリケーションを提供する
            - HTTP,DNS,FTP,FTP,SSL/TLS,Syslog,SNMP,NTP
    - OSI参照モデル
        - 以下、下から順に7層で構成されている。それぞれ順々に処理を行う。
            - 物理層
                - デジタルデータを物理的な伝送媒体に流す変換、変調処理を行う
            - データリンク層
                - 物理層の信頼性を確保する処理を行う
            - ネットワーク層
                - 宛先となるコンピューターまでの通信経路を確保する
            - トランスポート層
                - アプリケーションの識別を行い、それに応じた通信制御を行う
            - セッション層
                - ログインやログアウトなどアプリケーションレベルの通信を管理する
            - プレゼンテーション層
                - アプリケーション層にわかるようにデータを変換する
            - アプリケーション層
                - アプリケーションの機能を提供する
- PDU
    - 各階層で処理されるひとまとまりのデータ、データの単位のことをPDUという
    - PDUは制御情報を含む「ヘッダー」と、データそのものである「ペイロード」で構成されており、処理される階層によって、名称が異なる
        - 物理層
            - ビット
        - データリンク層
            - フレーム
        - ネットワーク層
            - パケット
        - トランスポート層
            - セグメント(TCPの場合)、データグラム(UDPの場合)
        - アプリケーション層
            - メッセージ
- IEEE
    - 比較的ハードウェアの処理に近いプロトコル
    - 具体的なIEEE
        - イーサネット
        - 無線LAN
        - 無線PAN
        - 無線MAN
- IETF
    - 比較的ソフトウェア寄りのプロトコル
        - IPv4
        - TCP
        - DNS
        - IPv6
        - HTTP1.1
        - HTTP2 など
- 各階層が連携して動作する仕組み
    - カプセル化と非カプセル化
        - 送信端末はアプリケーション層から順にそれぞれの階層でペイロードにヘッダーをくっつけてPDUにしてから一つ下の階層に渡す。ヘッダーを付加する処理のことをカプセル化という
        - 一つ下の階層は、そのPDUをペイロードとして認識し、その階層のヘッダーを新しく付与する
        - 受信側は物理層から順に、それぞれの階層でPDUからヘッダーを取り外してペイロードのみを一つ上の階層に渡す。ヘッダーを取り外す処理のことを非カプセル化という
        - 一つ上の階層はそのペイロードをPDUとして認識し、その階層のヘッダーを取り外す
            <img width="651" alt="tcp1" src="https://github.com/RyotaroSeto/microservices-memo/assets/70475997/f1c87605-3c41-4962-a6e6-3e87668e266a">
            
    - コネクション型とコネクションレス型
        - コネクション型
            - コネクションとは通信端末同士に確立される倫理的な通信路のこと
            - コネクション型は、データを送信する前に通信相手に「データを送ってもいいですか」とお伺いして、コネクションを確立し、データをやり取りした後終了する
            - コネクション型はしっかりとした手順を踏むため、転送に若干時間がかかるが確実にデータを転送することができる
            - 代表的なコネクション型のプロトコルがTCP
        - コネクションレス型
            - いきなりデータを送ってコネクションを確立し、勝手に終了する
            - 送信したデータが必ずしも相手に届くとは限らないため、確実に転送できるとは言えないが、手順を省略している分、転送にかかる時間を短縮できる
            - 代表的なコネクションレス型のプロトコルがイーサネット
    - 定番プロトコル
        - 下から順に
            - 物理層とデータリンク層
                - 有線環境はイーサネット
                - 無線環境はIEEE802.11
            - ネットワーク層
                - IP
            - トランスポート層
                - TCPかUDP
                - 通信に信頼性を求めたい時はTCP,リアルタイム性を求めたい時はUDP
            - アプリケーション層
                - HTTP,HTTPS,QUIC,DNS
        - 実際に通信するときは、NICのデバイスドライバやOS、アプリケーションが各階層から使用するプロトコルを選んで、送信端末はカプセル化、受信端末は非カプセル化して通信を行う。
- ネットワークを構成する機器
    - ある階層で動作する機器はそれ以下の階層の基本的なプロトコルは処理できるが、それ階層より上の階層のプロトコルは処理できない。
    - 物理層で動作する機器
        - 物理層で動作する機器はパケットを光/電気信号に変換したり、電波に変調したりする機能を持っている
        - 光ファイバーに流す時は光信号に変換、LANケーブルに流す時は電気信号に変換
        - NIC
            - PCやサーバーなどのコンピューターをネットワークに接続するために必要なハードウェアのこと
            - 人によってネットワークインターフェイスやネットワークアダプタと言ったりするが機能はすべて同じ
            - PCやサーバー、スマホやタブレットなど、全てのネットワーク端末はアプリケーションとOSが処理したパケットをNICを使用してLANケーブルや電波に流す
        - リピーター
            - LANケーブルを流れる電気信号は伝送距離が長くなれば衰退し波形が壊れる
            - リピーターはそれをもう一度増幅し波形を整えてもう片方に転送する。それによって伝送距離を伸ばし、より遠くへパケットを届けられるようにできる
            - 最近は光ファイバーの普及もあり、あまり使われなくなっている
        - リピーターハブ
            - 受け取ったパケット(ビット)のコピーをそのまま他のすべてのポートに転送する機器
            - L2スイッチに置き換えられ、見る機会が少なくなった
        - メディアコンバーター
            - 電気信号と光信号を相互に変換する機器
            - 光ファイバーケーブルを接続できない機器しかない状況でネットワークを延ばしたい場合に使用する
            - 電気信号は衰退が激しく、LANケーブルは頑張っても100mまでしか延ばせない。そうなると光ファイバーケーブルを使用するしかなくなるが、光ファイバーケーブルに対応する機器は高価で手がでない。そんな時、接続する機器と機器の間にメディアコンバーターを挟み込み、途中を光信号で遠くまで飛ばして、ネットワークを延ばす
        - アクセスポイント
            - パケットを電波に変調・復調する機器。無線と有線の架け橋のようなもの
            - Wifiあるところに必ずアクセスポイントがある、Wifiに接続している時は、アクセスポイントを一旦経由して、有線のネットワークに入る。身近なアクセスポイントは家庭用Wifiルーター。
    - データリンク層で動作する機器
        - データリンク層で動作する機器はフレームのヘッダーに含まれる「MACアドレス」の情報のもとにフレーム転送する、MACアドレスはデータリンク層における住所
        - ブリッジ
            - ポートとポートの橋のような役割。端末から受け取ったMACアドレスをMACアドレステーブルで管理し、転送処理を行う。この転送処理のことをブリッジングという。ブリッジはL2スイッチに置き換えられ、単体機器として見ることはない
        - L2スイッチ
            - たくさんポートを持っているブリッジ。スイッチングハブと言ったりもする
            - ブリッジと同じで、端末から受け取ったフレームのMACアドレスをMACアドレステーブルで管理し転送処理を行う。この転生処理のことをL2スイッチングという。
            - L2スイッチはブリッジよりもたくさんの端末を接続できるため汎用性が高く、世の中に存在する有線端末のほぼすべてがL2スイッチを介してネットワークにつながっている
            - 家電量販店やオフィスのフロアでたくさんのポートがついている機器がL2スイッチ
    - ネットワーク層で動作する機器
        - ネットワーク層で動作する機器はIPパケットのヘッダーに含まれるIPアドレスの情報を元にパケット転送する
        - ルーター
            - 端末から受け取ったIPパケットのIPアドレスをみて、自分のネットワークを超えたところにいる端末へと届ける役割。
            - IPアドレスをバケツリレーして目的地へと届ける。このバケツリレーのことをルーティングという。身近でいうとWifiルーターなど
            - ルーターはルーティングテーブルという表を元にパケットの受け渡し先を管理している
        - L3スイッチ
            - L2スイッチを足し合わせたような機器。ポートをたくさん持っているためたくさんの端末を接続でき、IPパケットをルーティングすることもできる。
            - L3スイッチはMACアドレステーブルとルーティングテーブルを組み合わせた情報をFPGAやASICなどのパケット転送処理専用ハードウェアに書き込み、その情報を元にスイッチングしたり、ルーティングしたりする。
    - トランスポート層で動作する機器
        - アプリケーションを識別し、その要件に応じた通信制御を行う階層
        - トランスポート層で動作する機器は、セグメントまたはデータグラムのヘッダーに含まれるポート番号をもとにパケット転送を行う。
        - ファイアウォール
            - ファイアウォールは端末間でやり取りされるパケットのIPアドレスやポート番号を見て通信を許可したり、ブロックしたりする。この通信制御機能のことをステートフルインスペクションという。
    - アプリケーション層で動作する機器
        - 次世代ファイアウォール
            - ファイアウォールの進化版。ステートフルインスペクションに加え、VPNやIDS/IPSなど様々なセキュリティ機能を詰め込み、結合化を図っている。
            - IPアドレスやポート番号だけでなく、色々な情報をアプリケーションレベルで解析することで、トランディショナルファイアウォールより高次元のセキュリティ、高次元の運用管理性を実現している
        - WAF
            - Webアプリケーションサーバーの安全を守るために使用する機器。XSSやSQLインジェクションなどがここ最近増えている。
            - クライアントとサーバーの間でやり取りされる情報の振る舞いをアプリケーションレベルで一つ一つ検査し、必要に応じてブロックする
        - 負荷分散スイッチ(L7スイッチ)
            - サーバーの負荷を分散する機器。ロードバランサーと呼んだりL7スイッチと呼んだりする
            - 1台のサーバーで処理できるトラフィックの量は限られているが、負荷分散装置はクライアントから受け取ったパケットを負荷分散方式という決まりごとに基づき、背後にいる複数のサーバーに振り分けることによって、システム全体で処理できるトラフィック量の拡張を図る。
- 色々なネットワーク機器の形
    - データリンク層以上で動作するネットワーク機器はさらに「物理アプライアンス」と「仮想アプライアンス」の2種類に大別できる。
    - 物理アプライアンス
        - 目で見ることができる。箱型の装置。サーバーラックに搭載されていたり、家電量販店に並んでいるネットワーク機器をイメージするとわかりやすい。
        - 簡単な処理や逆に複雑な処理を別の専用ハードウェアに任せることで、処理の効率化を図り、パフォーマンス向上を図っている
    - 仮想アプライアンス
        - 仮想化技術を提供するソフトウェアの上で動作するネットワーク機器
        - 仮想化ソフトウェアを利用して、ハードウェアを仮想的に分割し、OSに割り当てることで、物理サーバーの分割を実現する
        - 仮想化技術によってできる機器を仮想マシンという。
        - 仮想化技術は物理的に何台もある機器を1台のサーバーに集約して、設置スペースの節約を図れたり、余りあるリソースを有効活用できたりと、システム管理者にとって、コスト以上のメリットをもたらす。
        - 最近ではネットワーク機器を仮想化しようとEFVの流れもあって、スペックと要件さえ見合えば仮想アプライアンスが選択されることが多い
- ネットワークの形

<img width="623" alt="tcp2" src="https://github.com/RyotaroSeto/microservices-memo/assets/70475997/f9a68002-ad6f-48fc-bfa3-4dbdaa0c35fc">

- LAN
    - local area networkの略。家庭や企業など限られた範囲のネットワークのこと
    - 企業のLANの場合、同時接続する規模が大きいため、それだけ端末のパケットをさばけるだけの性能を持つ機器で構成されている。冗長化機能やL2ループ防止機能などネットワークの運用継続性を担保する機能を持つ機器で構成されている。企業内LANの端末はアクセスポイントやL2スイッチに一旦接続し、エッジスイッチを集約するL3スイッチを経由して、インターネットや社内サーバーに接続する
- WAN
    - wide area networkの略。距離的に遠く離れた範囲のネットワークのこと。インターネットと閉域VPN網に大別でき、用途が異なる
    - インターネット
        - インターネットサービスプロバイダー(ISP)が持っているたくさんのルーターが国境を超えて無数のパケットを運んでいる。それぞれのISPにはAS番号というインターネット上で一意の管理番号が割り当てられている。ASはそれぞれの組織が管理している範囲のこと。
    - 閉域VPN網
        - 物理的に離れたLANとLANを接続するネットワーク。
        - インターネットで仮想的な専用線を作れる。
        - 企業の本社と支社を接続するような企業ネットワーク環境のイメージ
- DMZ
    - DeMilitarized Zoneの略。インターネットに公開するサーバーを設置するネットワークのこと。
    - 最近はクラウド上で構築することもあるが、データセンター上に自前構築すると必要
    - DMZの基本は、サーバーが提供するサービスを安定稼働させること。安定稼働に必要不可欠な機能が冗長化。
    - DMZはどの機器が故障してもどのケーブルが断線しても、即座に経路が切り替わり、サービスを提供し続けることができるように、同じ種別のネットワーク機器を並列に配置する。
- 新しいネットワークの形
    - SDN
        - software defined networkの略。ソフトウェアによって管理・制御される仮想的なネットワーク。あるいはそれを構成するための技術。運用管理のシンプル化を目的として、たくさんのネットワーク機器を扱うデータセンターやISPで使用されている。
        - SDNはネットワーク全体を制御するコントロールプレーンとパケットを転送するデータプレーンで構成されている。
        - SDNはオーバーレイ型とホップバイホップ型に大別できる。オーバーレイ型とホップバイホップ型どちらが多いかと言えば圧倒的にオーバーレイ型
            - オーバーレイ型はスイッチ間に仮想的なトンネルを作って、パケットを転送する方式。
            - ホップバイホップ型はスイッチ一つ一つに対して、経路の情報を配置し、その情報を元にパケットを転送する方式
    - CDN
        - 画像や動画、HTMLやCSSなどWebコンテンツで使用される、色々なファイルを大量配信するために最適化されたインターネット上のサーバーネットワーク。Webサイトの多くがこの仕組みを利用してWebコンテンツを配信している。
        - CDNはWebコンテンツを持っているオリジンサーバーと、そのキャッシュを持つエッジサーバーで構成されている。ユーザーは物理的に距離が近いエッジサーバーにアクセスする。エッジサーバーはキャッシュを持っていなかったり、有効期限が切れていたら、オリジンサーバーにアクセスする
    - IoT
        - 身の回りにあるものがインターネットにつながる仕組みのこと
        - IoTが要件に合わせたプロトコルを使用する。中でも代表的なプロトコルがCoAPとMQTT
            - MQTTはKafkaに似ている（ほぼ作りがKafka）
    - IaaS
        - サーバーやネットワークなどのインフラをインターネット上で構築するクラウドサービスの1つ
        - 物理層を意識する必要がない。
