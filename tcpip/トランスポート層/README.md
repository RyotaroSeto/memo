## トランスポート層

### UDP

- UDPは音声通話や名前解決、DHCPや時刻同期など即時性を求めるアプリケーションで使用する。フォーマットをシンプルにしたり、確認応答の手順を省略したりすることによって即時性向上を図っている
- UDPのフォーマット
    - 即時性に重きを置いているため、パケットフォーマットはシンプル
    - 送信元/宛先ポート番号
        - コネクションを作る時、OSが決められた範囲からランダムに割り当てた値を「送信元ポート番号」に、アプリケーションごとに定義されている値を「宛先ポート番号」にセットしてサーバーに送信する
    - UDPデータグラム長
        - UDPヘッダーとUDPペイロードをあわせたデータグラム全体のサイズを表す
    - チェックサム
        - 受け取ったUDPデータグラムが壊れていないか、整合性チェックに使用されるフィールド
- ポート番号
    - IPパケットを受け取った端末は、そのIPパケットをどのアプリケーションで処理すれば良いかわからない。そこでネットワークの世界ではポート番号を使用する
    - ポート番号とアプリケーションは一意に紐づいていて、ポート番号さえ見れば、どのアプリケーションにデータを渡せば良いかわかるようになる。
    - ポート番号は「System Ports」「User Ports」「Dynamic and/or Private Ports」の3種類に分類される
    - System Ports
        - ポート番号0~1023
        - 一般的なサーバーアプリケーションに一意に紐づいている。
        - 80はHTTP、443はHTTPS、22はSSHなどに紐づいている
    - User Ports
        - ポート番号1024~49151
        - メーカーが開発した独自のアプリケーション一意に紐づいている
        - 3306はMySQLなど
    - Dynamic and/or Private Ports
        - ポート番号49152~65535
        - クライアントアプリケーションがコネクションを作る時、送信元ポート番号としてランダムに割り当てる。ランダムに割り当てるポート番号の範囲はOSごとに異なる
- ファイアウォールの動作(UDP編)
    - あらかじめ設定したルールに従って、この通信は許可、この通信は拒否など通信を選別して脅威からシステムを守る
    - このファイアウォールの持つ通信制御機能をステートフルインスペクションという
        - 通信の許可拒否を定義するフィルタリングルールと通信を管理するコネクションテーブルを用いて、通信を制御する
    - フィルタリングルール
        - どんな通信を許可し、どんな通信を拒否するか定義している設定
        - 送信元IPアドレス、宛先IPアドレス、プロトコル、送信元ポート番号、宛先ポート番号、通信制御などの設定項目で構成されている
    - コネクションテーブル
        - フィルタリングルールをコネクションの情報をもとに動的に書き換えることによってセキュリティ強度を高める
        - 送信元IPアドレス、宛先IPアドレス、プロトコル、送信元ポート番号、宛先ポート番号、コネクションの状態、アイドルタイムアウトなど各種要素からなる複数のコネクションエントリで構成されている

## TCP

- メールやファイル転送、Webブラウザなどデータを送り届けることについて信頼性を求めたいアプリケーションで使用
- TCPはアプリケーションデータを送信する前にTCPコネクションという論理的な通信経路を作って、通信環境を整える。
- TCPコネクションはそれぞれの端末から見て、送信専用に使用する送信パイプと受信専用に使用する受信パイプで構成されている
- TCPのパケットパフォーマンス
    - TCPはたくさんのフィールドをフルに活用してどの「送ります」に対する「受け取りました」なのかを確認したり、パケットの送受信量を調整したりする
    - 送信元/宛先ポート番号
    - シーケンス番号
        - TCPセグメントを正しい順序に並べるために使用されるフィールド
        - 送信側の端末はアプリケーションから受け取ったデータの各バイトに対して初期シーケンス番号から順に、通し番号を付与する。受信側の端末はシーケンス番号を確認して番号順に並べた上でアプリケーションに渡す
    - 確認応答番号
        - 次はここからのデータをくださいと相手に伝えるために使用するフィールド
        - TCPはシーケンス番号と確認応答番号を協調的に動作させることによってデータの信頼性を確保している
    - データオフセット
        - TCPヘッダーの長さを表すフィールド
    - コントロールビット
        - コネクションの状態を制御するフィールド。
        - TCPはコネクションを作る時、これらのフラグを「0」にしたり「1」にしたりすることによって、現在コネクションがどのような状態にあるか伝えあっている
    - ウィンドサイズ
        - 受け取れるデータサイズを通知するためのフィールド
        - これくらいまでだったら受け取れますよと確認応答を待たずに受け取れるデータサイズをウィンドウサイズとして通知する。送信側の端末はウィンドサイズが0のパケットを受け取ると、一旦送信するのを止める
    - チェックサム
        - 受け取ったTCPセグメントが壊れていないか整合性チェックに使用されるフィールド
        - TCPセグメントを受け取った端末は検証に成功するとセグメントを受け入れる
    - 緊急ポインタ
        - コントロールビットのURGフラグが1になっているときだけ有効なフィールド
    - オプション(以下は重要なオプション)
        - MSS
            - TCPペイロードの最大サイズ。
        - SACK
            - 消滅したTCPセグメントだけを再送する機能。再送効率が向上する
- TCPにおける状態
    - 接続開始フェーズ
        - 3ウェイハンドシェイクでコネクションをオープンするところから始まる
        - 3ウェイハンドシェイクとは、コネクションを確立する前に行う挨拶を表す手順
    - 接続確立フェーズ
        - フロー制御、輻輳制御、再送制御を組み合わせて転送を行っている
- 色々なオプション機能
    - TCP Fast Open
        - 3ウェイハンドシェイクを使用してアプリケーションデータをやりとりする機能
    - Nagleアルゴリズム
        - データサイズが小さいTCPセグメントをまとめて送信する機能
    - 遅延ACK
        - データサイズが小さいTCPセグメントに対する確認応答を少しだけ遅らせる機能
    - Early Retransmit
        - Fast Retransmitがはっせいしない特定のTCP環境において、重複ACKの閾値を下げ、Fast Retransmitを誘発する機能
    - Tail Loss Probe
        - 送信した一連のTCPセグメントのうち最後の方が失われてしまった場合に、再送タイムアウトよりも早く再送を試みる機能
- ファイアウォールの動作(TCP)
    - ほぼUDPとおなじだが、コネクションテーブルにコネクションの情報を示す列が追加され、その情報をもとにコネクションエントリを管理する
