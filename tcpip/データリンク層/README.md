## データリンク層

### 有線LAN(IEEE802.3)

- イーサネットのフレームワーク
    - イーサネットによってカプセル化されるパケットのことをイーサネットフレームワークという
    - Webやメール、ファイル共有から認証に至るまで、TCP/IPでやり取りするほとんどのパケットがイーサネットII規格を使用している
    - イーサネットIIは以下5つのフィールドで構成されている.
        - プリアンシブル
        - 宛先/送信元MACアドレス
        - タイプ
        - イーサネットペイロード
        - FCS(イーサネットトレーラー)
    - プリアンシブル,宛先/送信元MACアドレス,タイプを合わせてイーサネットヘッダーという。
    - プリアンシブル
        - 「これからイーサネットフレーム送りますよ」という合図を意味する8バイト(64ビット)の特別なビットパターン
        - 受信側の端末はイーサネットフレームの最初に付与されている、この特別なビットパターンをみて「これからイーサネットフレームが届くんだな」と判断する
    - 宛先/送信元MACアドレス
        - イーサネットネットワークに接続している端末を識別する6バイト(48ビット)のID
        - イーサネットネットワークにおける住所のようなもの
        - 送信側の端末は、イーサネットフレームを送り届けたい端末のMACアドレスを「宛先MACアドレス」に、自分のMACアドレスを「送信元MACアドレス」にセットしてイーサネットフレームを送出する。
        - 受信側の端末は、宛先MACアドレスを見て、自分のMACアドレスだったら受け入れ、関係ないMACアドレスだったら破棄する。また送信元MACアドバイスをみて、どの端末から来たイーサネットフレームなのか判別する
    - タイプ
        - ネットワーク層でどんなプロトコルを使用しているかを表す2バイト(16ビット)のID
        - 使用するプロトコルによって値が決められている
    - イーサネットペイロード
        - ネットワーク層のデータそうものを表す。
        - 例えば、ネットワーク層でIPを使用しているのであれば、「イーサネットペイロード=IPパケット」
    - FCS
        - イーサネットフレームが壊れていないかを確認する4バイト(32ビット)のフィールド
        - 送信側の端末は、イーサネットフレームを送信する時「宛先MACアドレス」「送信元MACアドレス」「タイプ」「イーサネットペイロード」に対して、一定の計算を行い、その結果をFCSとしてフレームの最後に付加する
        - 受信側の端末は、受け取ったイーサネットフレームに対して、同じ計算を行い、その値がFCSと同じだったら壊れていない。正しいイーサネットフレームと判断する
        - FCSがイーサネットにおけるエラー検知を全てになっている
- MACアドレス
    - イーサネットにおいて最も重要なフィールドが宛先MACアドレスと送信元MACアドレス
    - MACアドレスはイーサネットネットワークに接続している端末の識別ID
    - 6バイト(48ビット)で構成されていて「00-0c-29-43-5e-be」や「04:0c:ce:da:3a:6c」のように1バイト(8ビット)ずつハイフンやコロンで区切って、16進数で表記する
    - 通信の種類ごとのMACアドレスの違い
        - イーサネットネットワークにおける通信は「ユニキャスト」、「ブロードキャスト」、「マルチキャスト」の3種類がある。これらは通信の宛先によって使い分けられ、宛先MAアドレスにセットするMACアドレスが微妙に異なる
        - ユニキャスト
            - 1:1の通信。Webやメールなどよくあるインターネットの通信はこれ
        - ブロードキャスト
            - 1:nの通信。nは同じイーサネットネットワークに接続している自分以外の全ての端末。ある端末がブロードキャストを送信したら、そのイーサネットネットワークにいる自分以外の全ての端末がそのフレームを受信する。このブロードキャストが届く範囲をブロードキャストドメインという。
            - ブロードキャストの送信元MACアドレスは送信元端末のMACアドレスがそのまま入る。
        - マルチキャスト
            - 1:nの通信。nは特定のグループ(マルチキャストグループ)に入っている端末。ある端末がマルチキャストを送信したら、そのグループに入っている端末だけがそのパケットを受信する。
            - 主に動画配信や証券取引所のアプリケーションで使用されている
- L2スイッチ
    - L2スイッチング
        - イーサネットヘッダーに含まれている送信元MACアドレスと自分自身のポート番号をMACアドレステーブルというメモリ上の表で管理することによって、イーサネットフレームの転送先を切り替え、通信の効率化を図っている。このイーサネットフレームの転送先を切り替える機能をL2スイッチングという
    - VLAN
        - 1台のL2スイッチを仮想的に複数のL2スイッチに分割する技術
        - VLANを実現する機能は「ポートベースVLAN」「タグVLAN」の2種類に分けることができる
        - ポートベースVLAN
            - ひとつのポートに対して、一つのVLANを割り当てる機能
        - タグVLAN
            - イーサネットフレームにVLAN情報をVLANタグとしてくっつける機能
            - 一つのポート、一つのケーブルに複数のVLANのイーサネットフレームを流せるようにする
    - PoE
        - ツイストペアケーブルを使用して電源を供給する機能
        - 天井裏や壁裏など電源ケーブルが届きづらい場所に設置するアクセスポイントやネットワークカメラに対して、ツイストペアケーブル1本で電源とデータを両方供給できるようになり、コンセントを敷設する必要がなくなる

### 無線LAN(IEEE802.11)

- IEEE802.11フレームのフレームフォーマット
    - プリアンシブル
        - IEEE802.11フレームをおくりますよという合図
    - フレーム制御
        - データフレーム
            - IPパケットを送受信するためのフレーム
        - 管理フレーム
            - どのアクセスポイントとどのように接続するかを管理するフレーム
        - 制御フレーム
            - データフレームの転送を助けるためのフレーム
            - 無線LANは有線LANと比べて不安定なため、その確認応答を行う
    - Duration
    - MACアドレス1/2/3/4
        - データフレームのMACアドレス
            - インフラモード
                - アクセスポイントを介して通信するネットワーク構成
            - アドホックモード
                - アクセスポイントを介さず、無線LAN端末どうしが直接通信するネットワーク構成
            - WDSモード
                - アクセスポイントどうしで通信するネットワーク構成
        - 管理フレームのMACアドレス
            - 無線LAN端末とアクセスポイントだけでやりとりされるフレーム
        - 制御フレームのMACアドレス
            - 管理フレームと同じで、無線LAN端末とアクセスポイントだけでやりとりされるフレーム
    - シーケンス制御
    - IEEE802.11ペイロード
        - 管理フレームの場合無線LNAの名前を表すSSIDや使用するチャネル、サポートしている伝送速度などネットワークに関するいろいろな情報がセットされる
    - FCS
- 無線LAN端末が繋がるまで
    - 無線LANは有線LANと同等の機能を保ちつつ、よりセキュリティに気を配りながら接続する
    - アソシエーション→認証→共有鍵生成→暗号化通信の4つのフェーズを経て暗号化通信を行う
- アソシエーションフェーズ
    - どのアクセスポイントと接続するか決めるフェーズ
    - スキャンして、認証してアソシエーションする
    - スキャン
        - 周辺にある無線LANの情報を収集する。接続したいSSIDを見つけたら自分の存在をアクセスポイントに伝える
    - 認証
        - オープンシステム認証と共有鍵認証に2種類
        - オープンシステム認証
            - 認証処理行わない
        - 共有鍵認証
            - 共有されたパスワードをもとに認証
        - ここでの認証はとりあえずオープンシステム認証でパスさせておいて、実際の認証はアソシエーションフェーズの後の認証フェーズで行う
    - アソシエーション
        - 最終確認
- 認証フェーズ
    - パーソナルモードとエンタープライズモードがある
    - パーソナルモード
        - パスワードで認証する方式
        - パスワードからマスターキーと呼ばれる共有鍵の素を生成する
        - パーソナルモードはシンプルで分かりやすい半面パスワードが流出してしまうと誰でも接続できてしまうため定期的にパスワードを変更するべき
    - エンタープライズモード
        - デジタル証明書やIDパスワード、SIMカードなどを使用する認証方法
        - 認証サーバーで一元的に認証できるから企業でよく使われている
        - 無線LAN端末と認証サーバーはお互いが持っている情報を交換しあい互いが互いを証明しあう、認証が成功すると、認証サーバーからアクセスポイントと無線LAN端末にセッション鍵が配布され、それを元にマスターキーを生成する
        - ほかにもEAPというデジタル証明書やSIM等で双方向に認証を行うプロトコルもある
- 共有鍵生成フェーズ
    - 認証フェーズで生成したマスターキーから実際の暗号化/復号で使用する共有鍵を生成するフェーズ
- 暗号化通信フェーズ
    - 暗号化方式は以下で下に行くほどセキュリティレベルが上がる
        - WEP
            - 現在は使っていない
        - WPA
            - WEPを改良したが脆弱性があるためつかっていない
        - WPA2
            - WPAをさらに改良したもの
            - 暗号化アルゴリズムとしてAESを採用。とても安全で今のところ解読方法が見つかっていない
        - WPA3
            - WPA2をさらに改良したもの
            - AESよりさらに安全なCSNA対応
- 無線LANの形
    - 分散集中型
    - 集中管理型
    - クラウド管理型
- 無線LANに関する色々な機能
    - ゲストネットワーク
    - MACアドレスフィルタリング
    - Web認証
    - バンドステアリング

### ARP

- ネットワークの世界において、アドレスは「MACアドレス」と「IPアドレス」がある
- 「MACアドレス」はNICそのものに焼き付けられている物理的アドレス。
    - データリンク層で動作
- 「IPアドレス」はOS上で設定する論理的なアドレス
    - ネットワーク層で動作
- このふたつのアドレスを紐付け、データリンク層とネットワーク層の架け橋的な役割を担っているプロトコルが「ARP」
- 送信元MACアドレスは自分自身のNICに書き込まれているのでわかるが、宛先MACアドレスについては知らない。そこで実際のデータ通信に先立って、ARPで宛先IPv4アドレスから宛先MACアドレスを求める。これをアドレス解決という
- ARPのフレームフォーマット
    - ARPはL2ペイロードにデータリンク層とネットワーク層の情報を詰め込むことによって、MACアドレスととIPアドレスの紐付けを行っている
    - 以下は各フィールド
        - ハードウェアタイプ
        - プロトコルタイプ
        - ハードウェアアドレスサイズ
        - プロトコルアドレスサイズ
        - オペレーションコード
        - 送信元MACアドレス/送信元IPv4アドレス
        - 目標MACアドレス/目標IPv4アドレス
- ARPにおけるアドレス解決の流れ
    - 宛先PCに○○はいますか？と投げて、私ですと返すように流れ。
- ARPのキャッシュ機能
    - 全ての通信の始まりの始まりはARP。ARPでパケットを送信するべきMACアドレスを知って、初めて通信できるようになる
    - 弱点として、ブロードキャストを前提としているため全ての端末に対してデータを送る非効率な通信。MACアドレスもIPv4もそんなに頻繁に変わるわけではないため、ARPはアドレス解決した内容を一定時間保持するキャッシュ機能がある
- GARPを利用した機能
    - ARP以外にも効率的なアドレス解決を実現するための特別なARP。
    - ARPフィールドの目標IPv4アドレスに自分自身のIPv4アドレスをセットした特別なARP
    - IPv4アドレスの重複検知ができる
    - 隣接機器のテーブル更新ができる

### その他のL2プロトコル

- PPP
    - ポイントとポイントを1:1で結ぶためのレイヤー2プロトコル
- PAP
    - PPPクラウアントがユーザーIDとパスワードを送信し、サーバーがあらかじめ設定してあるユーザーIDをパスワードを元に認証する。
- CHAP
    - PAPのセキュリティ的な弱点をカバーしてパワーアップさせているプロトコル
- PPPoE
    - もともとダイヤルアップ接続で使用されていたPPPをイーサネットネットワーク上でも使用できるように拡張したプロトコル
    - フレッツ光ネクトとでフレッツ網と呼ばれる閉域網に接続する時使用する。
- IPoE
    - PPPoEのようにPPPでカプセル化することなく、イーサネットとIPをそのまま使用できることからネイティブ接続方式と呼ばれる
- PPTP
    - IPsecと同じようにインターネット上に仮想的な専用線(トンネル)を作るVPNプロトコル
    - 暗号化機能がないや脆弱性があるなどで使用されていない傾向
- L2TP
    - IPsecやPPTPと同じくインターネットに仮想的な専用を作るプロトコル
- L2TP over Ipsec
    - L2TPは暗号化機能を持っていないため、それ単体で使用しない。セキュリティ機能を持つIPsecを併用してL2TP over Ipsecとして使うのがほとんど
