
## ネットワーク層

### IPv4

- IPv4のパケットフォーマット
    - IPによってカプセル化されるパケットをIPパケットという。
        - IPパケットはIPヘッダーとIPペイロードで構成されている
        - パケット交換通信鍵を持っているのがIPヘッダー
    - IPヘッダーの各フィールド
        - バージョン
            - IPv4は4
        - ヘッダー長
            - IPv4のヘッダーの長さ
        - ToS
            - IPv4パケットの優先度を表す1バイトのフィールド
            - 優先制御や帯域制御、輻輳制御などのQoSで使用する
                - あらかじめこの値だったら最優先で転送するなどふるまいを設定しておく
        - パケット長
            - IPv4ヘッダーとIPv4ペイロードをあわせたパケット全体の長さを表す
            - パケットを受け取る端末はこのフィールドを見ることによってどこまでがIPv4パケットなのか知ることができる
        - 識別子
            - パケット交換方式の通信では、データをそのままの状態で送信するわけではなく、送りやすいように小分けに送信する。IPでデータを小分けにする処理をIPフラグメンテーションという。
            - 「識別子」「フラグ」「フラグオフセット」にはIPフラグメンテーションに関する情報が格納されている
            - 識別子はパケットを作成するときにランダムに割り当てるパケットのID
        - フラグ
            - フラグは3ビットで構成されていて、1ビット目は使用しない。
            - 2ビット目は「DFビット」といい、IPパケットをフラグメンテーションして良いかどうか表す。0だったらフラグメンテーションを許可し、1なら許可しない。
                - フラグメンテーションが発生すると、その分処理遅延が発生し、パフォーマンスは劣化する。なので最近のアプリは1にして許可しないようにして、上位層でデータサイズの調整をしている
            - 3ビット目はMFビットといい、フラグメンテーションされたIPv4パケットが後ろに続くかどうか表す。0だったらフラグメンテーションされたIPv4パケットが後ろに続かない。1だったらフラグメンテーションされたIPv4パケットが後ろにつく
        - フラグメントオフセット
            - フラグメンオフセットはフラグメンテーションしたとき、そのパケットがオリジナルパケットの先頭からどこに位置するかを示すフィールド
            - パケットを受け取る端末はこの値を見て、IPパケットの順序を正しく並べている
        - TTL
            - TTLはパケットの寿命を表すフィールド。IPの世界では、IPパケットの寿命は「軽油するルーターの数」で表す。軽油するルーターの数をポップ数という
            - TTLの値はルーターを軽油するたびに、つまりネットワークを軽油するたびにひとつずつ減算され、値が「0」になるとパケットが破棄される
        - プロトコル番号
            - Pv4ペイロードがどんなプロトコルで構成されているか表す
        - ヘッダーチェックサム
            - Pv4ヘッダーの整合性をチェックするために使用されるフィールド
        - 送信元/宛先Pv4アドレス
            - Pv4ネットワークに接続されている端末を泡ラス４バイトの識別ID
            - Pv4ネットワークにおける住所のようなもの
            - IPネットワークで通信する端末は全てIPアドレスを持つ必要がある。
            - 必ずしも1端末あたり一つのIPアドレスしか持てないわけではなく、機器の種類や用途に応じて、複数のIPアドレスをもつことも可能
                - 例えば、ルーターはIPネットワークに繋ぐために、ポートごとにIPアドレスを持ち、合わせて管理するためだけに用意されるイーサネット管理ポートにもIPアドレスを持つ
        - オプション
            - IPv4パケット送信における拡張機能が格納される可変長のフィールド
        - パディング
            - IPv4ヘッダーのビット数を整えるために使用されるフィールド
- IPv4アドレスとサブネットマスク
    - IPv4は32ビット(4バイト)で構成されていて、「192.168.1.1」や「172.16.1.1」のように8ビット(1バイト)ずつドットで区切って、10進数で表記する。ドットで区切られたグループのことをオクテットという。先頭から第1オクテット,第2オクテット…
    - サブネットマスクはネットワークとホストの分かれ目
        - IPv4じゃそれ単体で使用するわけでなく、サブネットマスクという32ビットの値とセットで使用する
        - IPv4アドレスはネットワーク部とホスト部の二つで構成されている。
            - ネットワーク部は「どのIPv4ネットワークにいるのか」を表す
            - ホスト部は「どの端末なのか」を表す。
        - サブネットマスクはこの二つを区切る目印ののようなもの1がネットワーク部、0がホスト部で表す
        - IPv4アドレスとサブネットマスクを組み合わせて見ることによって、「どのIPv4ネットワークにいるどこの端末なのか」を識別することができる
    - 10進数表記とCIDR表記
        - サブネットマスクには10進数表記とCIDR表記の2種類の表記方法がある
            - 例えば「192.168.100.1」というIPv4アドレスに「255.255.255.0」というサブネットマスクが設定されている場合、CIDR表記では「192.168.100.1/24」となる。
                - どちらにせよ、ネットワーク部が「192.168.100.1」でホスト部が「1」であることがわかる
- いろいろなIPv4アドレス
    - IPv4アドレスは「0.0.0.0」から「255.255.255.255」まで43億個あるがどれも好き勝手使って良いわけではない。どのように使うか決まっている
    - クラスフルアドレッシング
        - アドレスクラスにもとづいてIPv4アドレスを割り当てる方式
    - クラスレスアドレッシング
        - アドレスクラスにとらわれずにIPv4アドレスを割り当てる方式
        - ネットワーク部とホスト部の他にサブネット部という新しい概念を導入して、新しいネットワーク部を作り出す
    - 使用場所による分類
        - IPv4アドレスは使用場所によって「グローバルIPv4アドレス」と「プライベートIPv4アドレス」の2種類に分類できる
            - 前者はインターネットにおける一位なIPv4アドレス。後者は企業や家庭のネットワークなど限られた組織内だけで一意なIPv4アドレス
        - グローバルIPv4アドレス
        - プライベートIPv4アドレス
            - IPアドレスを変換することをNATという
    - 除外アドレス
        - 端末には設定できないアドレス、中でも実務で重要なIPアドレスが「ネットワークアドレス」、「ブロードキャストアドレス」、「ループバックアドレス」の3つ
        - ネットワークアドレス
            - ホスト部のビット数が全て0のIPv4アドレスでネットワークそのものを表す。
            - 例えば「192.168.100.1」というIPアドレスに「255.255.255.0」というサブネットマスクが設定されていたら、「192.168.100.0」がネットワークアドレス
        - ブロードキャストアドレス
            - ホスト部のビット数が全て「1」のIPv4アドレスで同じネットワークに存在する全ての端末で表す
            - 例えば「192.168.100.1」というIPアドレスに「255.255.255.0」というサブネットマスクが設定されていたら、「192.168.100.255」がブロードキャストアドレス
        - ループバックアドレス
            - 自分自身を表すIPv4アドレス。

### IPv6

- IPv4は43億子までしかIPアドレスを割り当てられないため、使い切る未来を避けるために新たに標準化されたのがIPv6
- IPv4との違いはヘッダーの長さとフィールド数の削減
    - IPv6はヘッダーの長さが長く、40バイト固定
    - IPv6は性能向上の足しかせになっていたりしたフィールドを削り、徹底的なシンプル化が図られている
        - フィールド数が減ることでたくさんのフィールドを精査する必要がなくなり、ネットワーク機器の処理負荷が軽減し、パフォーマンスが向上
    - バージョン
        - バージョンは6
    - トラフィッククラス
    - フローラベル
        - 通信フローを識別するもの
        - IPv4にはこのフィールドはない。別の方法でやっていた
    - ペイロード長
        - IPv4ではパケット長としてヘッダーとペイロードの長さを合わせた値で表現されていた
    - ネクストヘッダー
        - IPv6ヘッダーの直後に続くヘッダーを表す。拡張ヘッダーがある場合、拡張ヘッダーを示す値が入る
    - ホップリミット
        - ポップ数の上限を表す。IPv4のTTLに相当する
    - 送信元/宛先IPv6アドレス
        - IPv4アドレスとは大きく変わらない
- IPv6アドレスとプレフィックス
    - サブネットプレフィックスとインターフェイスID
        - IPv6アドレスはネットワークを識別する「サブネットプレフィックス」と、端末を識別する「インターフェースID」の二つで構成されている
        - サブネットプレフィックスはIPv4でいうネットワーク部。
        - インターフェイスIDはIPv4でいうホスト部。
    - IPv6アドレスの表記ルール
        - 各フィールドの先頭にある連続する「0」は省略できる
        - 複数のフィールドをまたいで「0」が続く場合は、「::」に省略できる
            - 省略できるのは一回だけ
            - オール「0」のフィールドがひとつの場合は省略できない
            - 可能な限り短くする
            - 最も省略できるところで省略する
            - 省略できるところが同じ長さだった場合は最初の箇所で省略する
            - 小文字で表記する
    - IPv6アドレスは複雑すぎてなかなか普及が進まない。
- いろいろなIPv6アドレス
    - ユニキャストアドレス
        - 1:1のユニキャスト通信で使用するIPv6アドレス。webやメールの通信はクライアントとサーバーの間だけでパケットがやり取りされるユニキャスト
        - グローバルユニキャストアドレス
            - IPv4のグローバルIPv4アドレス相当
        - ユニークローカルアドレス
            - IPv4アドレスのプライベートIPv4アドレス相当
        - リンクローカルアドレス
            - 同じIPv6ネットワークにおいてのみ通信できるアドレス。全てのIPv6インターフェースにはリンクローカルアドレスを割り当てる必要があり、デフォルトで自動的に割り当てられる。
    - マルチキャストアドレス
        - IPv4アドレスのクラスDに相当する。特定のグループ(マルチキャストグループ)に対する通信で使用する。
        - IPv4のマルチキャストは動画配信サービスや証券取引アプリなど限られた用途に使用していたが、IPv6ではIPv6におけるARPであるNDPでもマルチキャストが使用されていて、かなり重要な役割を担っている。IPv4にあったブロードキャストも、IPv6ではマルチキャストの一部として吸収された
    - エニーキャストアドレス
        - 複数の端末によって共有されているグローバルユニキャストアドレス。
        - グローバルユニキャストアドレスは一つ一つの端末に割り当て、1:1の通信に使用
        - 一つのグローバルユニキャストアドレスを複数の端末に割り当てるとエニーキャストアドレスになる
            - エニーキャストアドレスに対してパケット送信すると、そのパケットはルーターによって、経路的に最も近いサーバーに転送される。エニーキャストは単純にユニキャストで通信するより、より近いサーバーで応答を返すことができるため応答速度の向上を図れる。また広域で負荷分散が図れたりDDos攻撃の局所化を図れたり様々なメリットがある
         
### IPルーティング

- ルーティングとは
    - ルーターやL3スイッチは、宛先IPアドレスと照らし合わせる「宛先ネットワーク」という情報と、IPパケットを転送すべき隣接機器のIPアドレスを表す「ネクストポップ」という情報を管理することによって、IPパケットの転送を切り替えている。このIPパケットの転送先を切り替える機能を「ルーティング」という。
    - また宛先ネットワークとネクストポップを管理する表をルーティングテーブルという。
    - ルーティングはルーティングテーブルありきで行われる
- ルーティングテーブルの作り方
    - 静的ルーティングと動的ルーティングがある
    - 静的ルーティング
        - 手動でルーティングテーブルを作る方法。
        - 宛先ネットワークとネクストポップを一つ一つ設定する
    - 動的ルーティング
        - 隣接するルーター同士で自分の持っているルート情報を交換して、自動でルーティングテーブルを作る方法。ルーティング情報を交換するためのプロトコルをルーティングプロトコルという。
        - 動的ルーティングを使用すると、自動的にルーティングテーブルを更新したり、変更を通知しあったりして、新しいルートを確保する
        - 障害が起きても経路を確保してくれる
- ルーティングプロトコル
    - 制御範囲によってIGP(内部ゲートウェイプロトコル)とEGP(外部ゲートウェイプロトコル)の2種類に分けられる。この二つを分ける概念がAS
        - ここではAS=組織と考えて良い
        - AS内を制御するルーティングプロトコルがIGP、ASとASの間を制御するルーティングプロトコルがEGP
    - IGPのポイントはルーティングアルゴリズムとメトリック
        - ルーティングアルゴリズム
            - どうやってルーティングテーブルを作るかのルール。
                - ディスタンスベクター型
                    - 距離と方向に基づいてルートを計算する
                - リンクステート型
                    - リンクの状態(ステート)に基づいて最適ルートを計算する
        - メトリック
            - 宛先ネットワークまでの距離
        - IGPは「RIP」「OSPF」「EIGRP」
            - 現在のネットワーク環境で使用されるルーティングプロトコルは「RIP」「OSPF」「EIGRP」のいずれか
            - RIP
                - ディスタンスベクター型のルーティングプロトコル
                - ルーティングネットワークが大きくなればなるほど余計なネットワーク帯域を消費し収束に時間がかかるため大規模ネットワークに不向き
                - メトリックには「ポップ数」を使用。ポップ数は宛先ネットワークに行くまでに経由するルータの数を表して、ルーターを経由すればするほど遠くなる
            - OSPF
                - リンクステート型のルーティングプロトコル
                - 各ルーターがリンクの状態や帯域幅、IPアドレス、サブネットマスクなど色々な情報を交換しあって、リンクステートデータベースを作る。そしてそこから最適なルート情報を計算し、ルーティングテーブルを作る。
                - 相手が正常の時にだけ確認しているため、必要以上に帯域を圧迫しない。
                - またエリアという概念がある。色々な情報を集めて作られるLSDBが大きくなりすぎないようにネットワークをエリアに分けて、同じエリアのルーテーだけでLSDBを共有するようにする
                - メトリックにはコストを使用する。
                - ルーターが学習したルートのコストが全く同じだった場合、コストが同じルートを全て使用して、通信を負荷分散する
            - EIGRP
                - ディスタンスベクター型プロトコルを拡張したもの。
                - ルーターは最初に自分の持つルート情報だけを抽出し、ルーティングテーブルを作る。変更があった時だけルーティングテーブルの更新を行う
                - メトリックにはデフォルトで帯域幅と遅延を使用する。
                - 宛先ネットワークまでのルートの中で最も小さい値を採用して計算する
                - メトリックが全く同じだったらそのルートを全て使用して通信を負荷分散する
        - EGPはBGP一択
            - AS番号
                - インターネットに送出されたパケットはルーターがBGPをやりとりすることで作られた全世界のルート情報「フルルート」を使用して、バケツリレーのように宛先IPアドレスを持つ端末に転送されていく
            - ルーティングアルゴリズム
            - ベスト選択アルゴリズム
    - 再配送
        - 複数のルーティングプロトコルを使用せざるを得ない場合、それぞれをうまく変換して、協調的に動作させる必要がある。この変換のこと
    - ルーティングテーブルのルール
        - 出来上がったルーティングテーブルをどうやって使用するか。ポイントは「ロンゲストマッチ」、「ルート集約」「AD値」
        - より細かいルートが優先(ロンゲストマッチ)
            - サブネットマスクが最も長いルートを使用するというルーティングテーブルのルール
        - ルート集約でまとめる
            - 複数のルートをまとめること。
        - 宛先ネットワークが全く同じだったらAD値で勝負する
            - AD値はルーティングプロトコルごとに決められている優先度のようなもの。値が小さければ小さいほど優先度が高い
    - VRF
        - 1台のルーターに独立した複数のルーティングテーブルを持たせる仮想化技術
    - ポリシーベースルーティング
        - ポリシーに基づいてルーティングする
- IPアドレスの割り当て方法
    - 割り当て方は「静的割り当て」と「動的割り当て」の2種類
    - 静的割り当て
        - 手動でIPアドレスを設定する
        - メリット:端末とIPアドレスが一意に紐づくためIPアドレスを管理しやすい
            - このIPアドレスを持つサーバーに対する通信が急増しているなど起きた時即座に判別できる
        - デメリット:端末が多くなればなるほどどの端末にどのIPアドレスを割り当てたかわからなくなり管理コストが高い
    - 動的割り当て
        - 端末に対して自動でIPアドレスを設定する
        - DHCPなどを駆使して自動で割り当てる
        - メリット:IPアドレスの管理の手間を省ける
        - デメリット:どの端末にIPアドレスが設定されたのかわかりづらい
        - IPv4による動的割り当てとIPv6による動的割り当てがある
- DHCPリレーエージェント
    - DHCPパケットをユニキャストに変換する機能で、DHCPクライアントから一つ目(1ポップ目)にあるルーターで有効

### NAT

- IPアドレスを変換する技術のことをNATという
    - 不足しがちなグローバルIPアドレスを節約できたり、同じネットワークアドレスを持つシステム間で通信できるようになったりできる
    - NATは変換前後のIPアドレスやポート番号をNATテーブルというメモリ上の表に基づいて管理する
- 静的NAT
    - 内部と外部のIPアドレスを1:1に紐づいて変換する
- NAPT
    - 内部と外部のIPアドレスをn:1に紐づけて変換する
- CGNAT
    - NAPTを通信事業者やISPで使用できるように拡張したもの
    - スマホのLTEアンテナに割り当てられているIPアドレス、これはNTTドコモやauであれば「10.x.x.x」のプライベートIPv4アドレスが割り当てられている。スマホのパケットは通信事業者のLTE網でグローバルIPv4アドレスにCGNATされてインターネットへと送出される
    - ポート割り当て機能がある
        - 静的割り当て
        - PBA
        - 動的割り当て
    - EIM/EIF機能(フルコーンNAT)
    - ヘアピンNAT
    - コネクションリミット
- NATトラバーサル(NAT超え)
    - NAT機器を超えて端末同士を直接通信する技術
    - 「ポートフォワーディング」「UPnP」「STUN」「TURN」
 
### IPv4とIPv6の共存技術

- デュアルスタック
    - 一つの端末にIPv4アドレスとIPv6アドレスの両方を割り当てる技術
    - IPv4アドレスをそのまま使用できるため、新しいIPv6に対応したい時でも既存のIPv4環境に影響が少ないというメリットがある
    - 反面IPv4とIPv6の両方を運用管理するため運用負荷というデメリットがある
- DNS64/NAT64
    - DNSサーバーの機能を利用してIPv6端末がIPv4端末と通信できるようにする技術
    - DNSとNATの合わせ技で通信可能にする
- トンネリング
    - IPv6ネットワークを経由してIPv4パケットを届ける、あるいはその逆に、IPv4ネットワークを経由してIPv6パケットを届ける技術

### ICMPv4

- IPレベルの通信を確認したり、色々なエラーを通知したりと、IPネットワークにおいて、なくてはならない重要な役割
    - pingはICMPパケットを送信する時に使用するネットワーク診断プログラム
- ICMPv4のパケットフォーマット
    - ICMPはインターネットを制御するメッセージをやりとりするプロトコル
- 代表的なICMPv4の動作
    - Echo Request/Reply
        - IPレベルの通信状態を確認する時に使用されるICMPv4パケットがEcho Request とEcho Reply
        - pingコマンドを実行すると、指定したIPアドレスに対してタイプ8,コード0のEcho Requestが送信される。
        - 疎通確認でEcho Replyが返ってくるのであれば、トランスポート層→アプリケーション層と上位層に向かって疎通確認する。
        - Echo Replyがかえってこなければ、ネットワーク層→データリンク層→物理層と下位に向かって疎通を確認する
    - Destination Unreachable
        - IPv4パケットを宛先IPv4アドレスの端末までルーティングできたかった時にエラーを通知するICMPv4パケットのこと。
    - Time-to-live exceeded
        - IPv4パケットのTTLが0になって破棄した時、それを送信元端末に対して通知するパケットのこと。ルーティンググループの防止と通信経路確認の役割を担っている
        - ルーティンググループ
            - ルーティングの設定ミスによってIPパケットが複数のルーターを伝わってぐるぐる回る現象のこと

### ICMPv6

- ICMPv4の機能に加え、MACアドレスを学習する機能やアドレス重複を検知する機能、ネットワーク情報を提供する機能などを持つ
- 代表的なICMPv6の動作
    - 動作としてはICMPv4とほぼ変わらず、加えて、近隣探索プロトコルという機能がある
    - 近隣探索プロトコル
        - IPv6アドレスの重複検知
        - 宛先IPv6アドレスから宛先MACアドレスを求める
        - ネットワーク情報の提供

### IPsec

- ネットワーク層でIPパケットのカプセル化や認証、暗号化を行い、インターネット上に仮想的な専用線を作る仮想化技術
- 最近ではオンプレとクラウドの接続に使用されている
- 拠点間VPNとリモートアクセスVPN
    - 拠点間VPN
        - 色々な場所に拠点がある企業接続に使用
        - 例えば、鹿児島本社と東京本社に分かれていた、そのトンネルを作る。
    - リモートアクセスVPN
        - モバイルユーザーやテレワーカーのリモートアクセスで使用される
        - VPN用の仮想的なNICを作り、VPN設置(ルーターやファイアウォール)にIPsecトンネルを作る
- IPsecプロトコルが持っている機能
    - IKE
        - 安全に通信するための事前準備
        - IKEv1
            - フェーズ1
                - トンネルを制御する
                - メインモード
                    - 設定の合意、暗号鍵の共有、接続相手の認証の順で3ステップの処理をおこなう
                - アグレッシブモード
                    - 設定の合意、暗号鍵の共有、接続相手の認証を1ステップで一気に行う
            - フェーズ2
                - 実際のデータをやりとりする
                - フェーズ1で作った上で必要な設定や暗号鍵の共有をおこない、上り通信用と下通信用の2本を作る。
        - IKEv2
            - IKEv1の問題を解消しつつ、新たに標準化されたプロトコル
            - やりとりにIKEv1と大きな違いがあるわけではないがシンプルになっている
    - ESP/AH
        - IKEの事前準備が完了したらデータ転送を開始
        - ESPとAHの違いは暗号化機能があるかどうか
    - NATトラバーサル
        - 送信元ポート番号がみえないと、その紐付けができずNAPTできない。
