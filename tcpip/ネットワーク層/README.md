
## ネットワーク層

### IPv4

- IPv4のパケットフォーマット
    - IPによってカプセル化されるパケットをIPパケットという。
        - IPパケットはIPヘッダーとIPペイロードで構成されている
        - パケット交換通信鍵を持っているのがIPヘッダー
    - IPヘッダーの各フィールド
        - バージョン
            - IPv4は4
        - ヘッダー長
            - IPv4のヘッダーの長さ
        - ToS
            - IPv4パケットの優先度を表す1バイトのフィールド
            - 優先制御や帯域制御、輻輳制御などのQoSで使用する
                - あらかじめこの値だったら最優先で転送するなどふるまいを設定しておく
        - パケット長
            - IPv4ヘッダーとIPv4ペイロードをあわせたパケット全体の長さを表す
            - パケットを受け取る端末はこのフィールドを見ることによってどこまでがIPv4パケットなのか知ることができる
        - 識別子
            - パケット交換方式の通信では、データをそのままの状態で送信するわけではなく、送りやすいように小分けに送信する。IPでデータを小分けにする処理をIPフラグメンテーションという。
            - 「識別子」「フラグ」「フラグオフセット」にはIPフラグメンテーションに関する情報が格納されている
            - 識別子はパケットを作成するときにランダムに割り当てるパケットのID
        - フラグ
            - フラグは3ビットで構成されていて、1ビット目は使用しない。
            - 2ビット目は「DFビット」といい、IPパケットをフラグメンテーションして良いかどうか表す。0だったらフラグメンテーションを許可し、1なら許可しない。
                - フラグメンテーションが発生すると、その分処理遅延が発生し、パフォーマンスは劣化する。なので最近のアプリは1にして許可しないようにして、上位層でデータサイズの調整をしている
            - 3ビット目はMFビットといい、フラグメンテーションされたIPv4パケットが後ろに続くかどうか表す。0だったらフラグメンテーションされたIPv4パケットが後ろに続かない。1だったらフラグメンテーションされたIPv4パケットが後ろにつく
        - フラグメントオフセット
            - フラグメンオフセットはフラグメンテーションしたとき、そのパケットがオリジナルパケットの先頭からどこに位置するかを示すフィールド
            - パケットを受け取る端末はこの値を見て、IPパケットの順序を正しく並べている
        - TTL
            - TTLはパケットの寿命を表すフィールド。IPの世界では、IPパケットの寿命は「軽油するルーターの数」で表す。軽油するルーターの数をポップ数という
            - TTLの値はルーターを軽油するたびに、つまりネットワークを軽油するたびにひとつずつ減算され、値が「0」になるとパケットが破棄される
        - プロトコル番号
            - Pv4ペイロードがどんなプロトコルで構成されているか表す
        - ヘッダーチェックサム
            - Pv4ヘッダーの整合性をチェックするために使用されるフィールド
        - 送信元/宛先Pv4アドレス
            - Pv4ネットワークに接続されている端末を泡ラス４バイトの識別ID
            - Pv4ネットワークにおける住所のようなもの
            - IPネットワークで通信する端末は全てIPアドレスを持つ必要がある。
            - 必ずしも1端末あたり一つのIPアドレスしか持てないわけではなく、機器の種類や用途に応じて、複数のIPアドレスをもつことも可能
                - 例えば、ルーターはIPネットワークに繋ぐために、ポートごとにIPアドレスを持ち、合わせて管理するためだけに用意されるイーサネット管理ポートにもIPアドレスを持つ
        - オプション
            - IPv4パケット送信における拡張機能が格納される可変長のフィールド
        - パディング
            - IPv4ヘッダーのビット数を整えるために使用されるフィールド
- IPv4アドレスとサブネットマスク
    - IPv4は32ビット(4バイト)で構成されていて、「192.168.1.1」や「172.16.1.1」のように8ビット(1バイト)ずつドットで区切って、10進数で表記する。ドットで区切られたグループのことをオクテットという。先頭から第1オクテット,第2オクテット…
    - サブネットマスクはネットワークとホストの分かれ目
        - IPv4じゃそれ単体で使用するわけでなく、サブネットマスクという32ビットの値とセットで使用する
        - IPv4アドレスはネットワーク部とホスト部の二つで構成されている。
            - ネットワーク部は「どのIPv4ネットワークにいるのか」を表す
            - ホスト部は「どの端末なのか」を表す。
        - サブネットマスクはこの二つを区切る目印ののようなもの1がネットワーク部、0がホスト部で表す
        - IPv4アドレスとサブネットマスクを組み合わせて見ることによって、「どのIPv4ネットワークにいるどこの端末なのか」を識別することができる
    - 10進数表記とCIDR表記
        - サブネットマスクには10進数表記とCIDR表記の2種類の表記方法がある
            - 例えば「192.168.100.1」というIPv4アドレスに「255.255.255.0」というサブネットマスクが設定されている場合、CIDR表記では「192.168.100.1/24」となる。
                - どちらにせよ、ネットワーク部が「192.168.100.1」でホスト部が「1」であることがわかる
- いろいろなIPv4アドレス
    - IPv4アドレスは「0.0.0.0」から「255.255.255.255」まで43億個あるがどれも好き勝手使って良いわけではない。どのように使うか決まっている
    - クラスフルアドレッシング
        - アドレスクラスにもとづいてIPv4アドレスを割り当てる方式
    - クラスレスアドレッシング
        - アドレスクラスにとらわれずにIPv4アドレスを割り当てる方式
        - ネットワーク部とホスト部の他にサブネット部という新しい概念を導入して、新しいネットワーク部を作り出す
    - 使用場所による分類
        - IPv4アドレスは使用場所によって「グローバルIPv4アドレス」と「プライベートIPv4アドレス」の2種類に分類できる
            - 前者はインターネットにおける一位なIPv4アドレス。後者は企業や家庭のネットワークなど限られた組織内だけで一意なIPv4アドレス
        - グローバルIPv4アドレス
        - プライベートIPv4アドレス
            - IPアドレスを変換することをNATという
    - 除外アドレス
        - 端末には設定できないアドレス、中でも実務で重要なIPアドレスが「ネットワークアドレス」、「ブロードキャストアドレス」、「ループバックアドレス」の3つ
        - ネットワークアドレス
            - ホスト部のビット数が全て0のIPv4アドレスでネットワークそのものを表す。
            - 例えば「192.168.100.1」というIPアドレスに「255.255.255.0」というサブネットマスクが設定されていたら、「192.168.100.0」がネットワークアドレス
        - ブロードキャストアドレス
            - ホスト部のビット数が全て「1」のIPv4アドレスで同じネットワークに存在する全ての端末で表す
            - 例えば「192.168.100.1」というIPアドレスに「255.255.255.0」というサブネットマスクが設定されていたら、「192.168.100.255」がブロードキャストアドレス
        - ループバックアドレス
            - 自分自身を表すIPv4アドレス。

### IPv6

- IPv4は43億子までしかIPアドレスを割り当てられないため、使い切る未来を避けるために新たに標準化されたのがIPv6
- IPv4との違いはヘッダーの長さとフィールド数の削減
    - IPv6はヘッダーの長さが長く、40バイト固定
    - IPv6は性能向上の足しかせになっていたりしたフィールドを削り、徹底的なシンプル化が図られている
        - フィールド数が減ることでたくさんのフィールドを精査する必要がなくなり、ネットワーク機器の処理負荷が軽減し、パフォーマンスが向上
    - バージョン
        - バージョンは6
    - トラフィッククラス
    - フローラベル
        - 通信フローを識別するもの
        - IPv4にはこのフィールドはない。別の方法でやっていた
    - ペイロード長
        - IPv4ではパケット長としてヘッダーとペイロードの長さを合わせた値で表現されていた
    - ネクストヘッダー
        - IPv6ヘッダーの直後に続くヘッダーを表す。拡張ヘッダーがある場合、拡張ヘッダーを示す値が入る
    - ホップリミット
        - ポップ数の上限を表す。IPv4のTTLに相当する
    - 送信元/宛先IPv6アドレス
        - IPv4アドレスとは大きく変わらない
- IPv6アドレスとプレフィックス
    - サブネットプレフィックスとインターフェイスID
        - IPv6アドレスはネットワークを識別する「サブネットプレフィックス」と、端末を識別する「インターフェースID」の二つで構成されている
        - サブネットプレフィックスはIPv4でいうネットワーク部。
        - インターフェイスIDはIPv4でいうホスト部。
    - IPv6アドレスの表記ルール
        - 各フィールドの先頭にある連続する「0」は省略できる
        - 複数のフィールドをまたいで「0」が続く場合は、「::」に省略できる
            - 省略できるのは一回だけ
            - オール「0」のフィールドがひとつの場合は省略できない
            - 可能な限り短くする
            - 最も省略できるところで省略する
            - 省略できるところが同じ長さだった場合は最初の箇所で省略する
            - 小文字で表記する
    - IPv6アドレスは複雑すぎてなかなか普及が進まない。
- いろいろなIPv6アドレス
    - ユニキャストアドレス
        - 1:1のユニキャスト通信で使用するIPv6アドレス。webやメールの通信はクライアントとサーバーの間だけでパケットがやり取りされるユニキャスト
        - グローバルユニキャストアドレス
            - IPv4のグローバルIPv4アドレス相当
        - ユニークローカルアドレス
            - IPv4アドレスのプライベートIPv4アドレス相当
        - リンクローカルアドレス
            - 同じIPv6ネットワークにおいてのみ通信できるアドレス。全てのIPv6インターフェースにはリンクローカルアドレスを割り当てる必要があり、デフォルトで自動的に割り当てられる。
    - マルチキャストアドレス
        - IPv4アドレスのクラスDに相当する。特定のグループ(マルチキャストグループ)に対する通信で使用する。
        - IPv4のマルチキャストは動画配信サービスや証券取引アプリなど限られた用途に使用していたが、IPv6ではIPv6におけるARPであるNDPでもマルチキャストが使用されていて、かなり重要な役割を担っている。IPv4にあったブロードキャストも、IPv6ではマルチキャストの一部として吸収された
    - エニーキャストアドレス
        - 複数の端末によって共有されているグローバルユニキャストアドレス。
        - グローバルユニキャストアドレスは一つ一つの端末に割り当て、1:1の通信に使用
        - 一つのグローバルユニキャストアドレスを複数の端末に割り当てるとエニーキャストアドレスになる
            - エニーキャストアドレスに対してパケット送信すると、そのパケットはルーターによって、経路的に最も近いサーバーに転送される。エニーキャストは単純にユニキャストで通信するより、より近いサーバーで応答を返すことができるため応答速度の向上を図れる。また広域で負荷分散が図れたりDDos攻撃の局所化を図れたり様々なメリットがある
